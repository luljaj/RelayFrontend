# Complete System Architecture: Agent Coordination Platform
## Visual Architecture Diagrams (No Code)

---

## Diagram 1: High-Level System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        BROWSER / CLIENT LAYER                               â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     Graph Visualization UI         â”‚  â”‚   Agent Activity Feed       â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚   (Agent Slack)             â”‚  â”‚
â”‚  â”‚  ğŸ“ src/auth/  ğŸ”´ Luka WRITING    â”‚  â”‚                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  ğŸ”§ Luka: Auth refactor     â”‚  â”‚
â”‚  â”‚  â”‚ File â”‚â”€â”€â–¶â”‚ Func â”‚â”€â”€â–¶â”‚ Func â”‚   â”‚  â”‚     complete, running tests â”‚  â”‚
â”‚  â”‚  â”‚  A   â”‚   â”‚  1   â”‚   â”‚  2   â”‚   â”‚  â”‚     Layer: backend/auth     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€ğŸ”´â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚                             â”‚  â”‚
â”‚  â”‚   auth.ts   validate   reset      â”‚  â”‚  ğŸ” Jane: Investigating DB  â”‚  â”‚
â”‚  â”‚             Token      Password    â”‚  â”‚     timeout issue           â”‚  â”‚
â”‚  â”‚             (Luka)     (OPEN)      â”‚  â”‚     Layer: backend/db       â”‚  â”‚
â”‚  â”‚                                    â”‚  â”‚                             â”‚  â”‚
â”‚  â”‚  ğŸ“ src/db/  ğŸ”µ Jane READING      â”‚  â”‚  [Real-time updates]        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â–²                              â–²                      â”‚
â”‚                       â”‚                              â”‚                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                      â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ WebSocket (wss://)
                                       â”‚ Real-time bidirectional
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚                                      â”‚
â”‚                      VERCEL WEBAPP (State + UI + WebSocket)                â”‚
â”‚                                      â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      WEBAPP COMPONENTS                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  1. Graph Creator:                                                   â”‚ â”‚
â”‚  â”‚     â€¢ Analyzes codebase and generates dependency graph               â”‚ â”‚
â”‚  â”‚     â€¢ Extracts symbols (functions, classes, etc.)                    â”‚ â”‚
â”‚  â”‚     â€¢ Maps dependencies between symbols                              â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  2. Status Log:                                                      â”‚ â”‚
â”‚  â”‚     â€¢ Stores all status updates and activity messages                â”‚ â”‚
â”‚  â”‚     â€¢ Queryable history of who did what when                         â”‚ â”‚
â”‚  â”‚     â€¢ Enables time-travel debugging                                  â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  3. Graph UI:                                                        â”‚ â”‚
â”‚  â”‚     â€¢ Interactive visualization of code graph                        â”‚ â”‚
â”‚  â”‚     â€¢ Real-time status indicators (ğŸ”´ WRITING, ğŸ”µ READING)           â”‚ â”‚
â”‚  â”‚     â€¢ Folder-level and symbol-level views                            â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  4. Chat:                                                            â”‚ â”‚
â”‚  â”‚     â€¢ Agent-to-agent and human-to-agent communication                â”‚ â”‚
â”‚  â”‚     â€¢ Contextual discussions about specific symbols                  â”‚ â”‚
â”‚  â”‚     â€¢ Coordination questions and decisions                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              WebSocket Connection Manager                             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â€¢ Maintains active connections: Set[WebSocket]                      â”‚ â”‚
â”‚  â”‚  â€¢ Broadcasts events to all clients (browsers + agents)              â”‚ â”‚
â”‚  â”‚  â€¢ Handles client connect/disconnect                                 â”‚ â”‚
â”‚  â”‚  â€¢ Streams real-time updates                                         â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Event Types Broadcast:                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  status_update    â†’ User posted new status (OPEN/READ/WRITE) â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  activity_posted  â†’ User posted to activity feed             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  lock_expired     â†’ Lock timed out (no heartbeat)            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  conflict_warning â†’ Multiple users on same symbol            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  dependency_warning â†’ Dependency being written               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  chat_message     â†’ New chat message posted                  â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   WEBAPP STATE (Persistent)                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â€¢ lock_table: Dict[str, LockEntry]                                  â”‚ â”‚
â”‚  â”‚  â€¢ activity_feed: List[ActivityEntry]                                â”‚ â”‚
â”‚  â”‚  â€¢ dependency_graph: Dict[str, List[str]]                            â”‚ â”‚
â”‚  â”‚  â€¢ repo_head: str (latest known HEAD)                                â”‚ â”‚
â”‚  â”‚  â€¢ status_log: List[StatusLogEntry] (full history)                   â”‚ â”‚
â”‚  â”‚  â€¢ chat_messages: List[ChatMessage]                                  â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Storage: Vercel KV / Postgres / Redis (your choice)                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   WEBAPP API ENDPOINTS                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  POST /api/check_status                                              â”‚ â”‚
â”‚  â”‚    â†’ Returns: repo_head, locks, recent_activity, stale_status        â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  POST /api/post_status                                               â”‚ â”‚
â”‚  â”‚    â†’ Updates lock_table, validates staleness, broadcasts             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  POST /api/post_activity                                             â”‚ â”‚
â”‚  â”‚    â†’ Adds to activity_feed, broadcasts to WebSocket clients          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  POST /api/heartbeat                                                 â”‚ â”‚
â”‚  â”‚    â†’ Updates last_heartbeat timestamp, prevents lock expiration      â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  POST /api/chat                                                      â”‚ â”‚
â”‚  â”‚    â†’ Posts chat message, broadcasts to all clients                   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  GET /api/graph                                                      â”‚ â”‚
â”‚  â”‚    â†’ Returns current dependency graph                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  POST /api/generate_graph                                            â”‚ â”‚
â”‚  â”‚    â†’ Triggers graph generation from codebase                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ HTTPS API Calls
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â–¼                                      â”‚
â”‚              COORDINATION LOGIC LAYER (MCP Server - STATELESS)             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ğŸ” Authentication Pipeline                         â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Every MCP Tool Call Flow:                                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  1. Tool invoked by agent                                            â”‚ â”‚
â”‚  â”‚      â†“                                                                â”‚ â”‚
â”‚  â”‚  2. get_context() extracts decrypted credentials                     â”‚ â”‚
â”‚  â”‚      â†“                                                                â”‚ â”‚
â”‚  â”‚  3. context.request_context.credentials["COORD_API_KEY"]             â”‚ â”‚
â”‚  â”‚      â†“                                                                â”‚ â”‚
â”‚  â”‚  4. Hash API key â†’ Lookup in user database                           â”‚ â”‚
â”‚  â”‚      â†“                                                                â”‚ â”‚
â”‚  â”‚  5. Return UserInfo { user_id, email, name }                         â”‚ â”‚
â”‚  â”‚      â†“                                                                â”‚ â”‚
â”‚  â”‚  6. Tool executes with authenticated user context                    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   MCP Tools (STATELESS - Forward to Webapp)           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  CRITICAL: MCP server is STATELESS (Dedalus requirement)             â”‚ â”‚
â”‚  â”‚  All state lives in the Vercel webapp.                               â”‚ â”‚
â”‚  â”‚  MCP tools authenticate user, then forward to webapp API.            â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  @tool(description="...")                                            â”‚ â”‚
â”‚  â”‚  async def check_interference(                                       â”‚ â”‚
â”‚  â”‚      request: CheckInterferenceRequest                               â”‚ â”‚
â”‚  â”‚  ) -> CheckInterferenceResponse:                                     â”‚ â”‚
â”‚  â”‚      ctx = get_context()                    â† Dedalus provides this â”‚ â”‚
â”‚  â”‚      user = authenticate_from_context(ctx)  â† Extract who called    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      # Forward to webapp API                                         â”‚ â”‚
â”‚  â”‚      response = await http_post(                                     â”‚ â”‚
â”‚  â”‚          f"{WEBAPP_URL}/api/check_status",                           â”‚ â”‚
â”‚  â”‚          json={                                                      â”‚ â”‚
â”‚  â”‚              "user_id": user.user_id,                                â”‚ â”‚
â”‚  â”‚              "symbols": request.symbols,                             â”‚ â”‚
â”‚  â”‚              "agent_head": request.agent_head                        â”‚ â”‚
â”‚  â”‚          }                                                            â”‚ â”‚
â”‚  â”‚      )                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      return CheckInterferenceResponse(**response.json())             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Available Tools (all forward to Vercel webapp):                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ check_status(symbols, agent_head)                             â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ POST /api/check_status                                      â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Returns conflicts + dependency warnings + repo state        â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ post_status(symbol, status, message, agent_head/new_repo_head)â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ POST /api/post_status                                       â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Status: "OPEN" | "READING" | "WRITING"                      â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Webapp updates lock table + broadcasts via WebSocket        â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ heartbeat(symbols)                                            â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ POST /api/heartbeat                                         â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Webapp updates last_heartbeat timestamps                    â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ post_activity(message, scope, intent)                         â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ POST /api/post_activity                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Webapp adds to activity_feed + broadcasts                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ post_chat(message, context)                                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ POST /api/chat                                              â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Webapp stores + broadcasts chat message                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ get_graph()                                                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ GET /api/graph                                              â”‚â”‚ â”‚
â”‚  â”‚  â”‚   â†’ Returns current dependency graph from webapp                â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     MCP Server Flow (Stateless)                       â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Every MCP tool call:                                                â”‚ â”‚
â”‚  â”‚  1. Authenticate user from Dedalus credentials                       â”‚ â”‚
â”‚  â”‚  2. Extract user_id, email, name                                     â”‚ â”‚
â”‚  â”‚  3. Forward request to Vercel webapp API                             â”‚ â”‚
â”‚  â”‚  4. Return webapp response to agent                                  â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  NO STATE stored in MCP server itself.                               â”‚ â”‚
â”‚  â”‚  All state lives in the Vercel webapp.                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ Returns response
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â–¼                                      â”‚
â”‚           STATE MANAGEMENT LAYER (Lives in Vercel Webapp, NOT MCP)         â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Webapp State Storage                              â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Persistent Data Structures (Vercel KV / Postgres / Redis):          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ lock_table: Dict[str, LockEntry]                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ Status: "OPEN" | "READING" | "WRITING"                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ {                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   "auth.ts::validateToken": {                               â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     symbol: "auth.ts::validateToken",                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: "luka",                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_email: "luka@example.com",                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_name: "Luka",                                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     status: "WRITING",                                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     message: "Refactoring to JWT",                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     timestamp: 1234567890.123,                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     last_heartbeat: 1234567920.456                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   },                                                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   "auth.ts::login": {                                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     symbol: "auth.ts::login",                               â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     status: "OPEN",  â† Not being worked on                 â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: null,                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     last_commit_sha: "abc123def",                           â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     last_commit_time: 1234567800.0,                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     last_commit_author: "jane",                             â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     last_commit_message: "feat: improve login flow"         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   }                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ }                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ user_database: Dict[str, UserInfo]                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ {                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   sha256("coord_sk_luka_abc123"): {                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: "luka",                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     email: "luka@example.com",                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     name: "Luka"                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   },                                                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   sha256("coord_sk_jane_xyz789"): {                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: "jane",                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     email: "jane@example.com",                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     name: "Jane"                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   }                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ }                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ activity_feed: List[ActivityEntry]                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ Agent Slack - High-level activity updates                   â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ [                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   {                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     id: "activity_001",                                     â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: "luka",                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_name: "Luka",                                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     message: "Moving to database layer",                    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     timestamp: 1234567890.0,                                â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     context: {                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚       layer: "backend/db",                                  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚       task_type: "refactor"                                 â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     }                                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   }                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ ]                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ dependency_graph: Dict[str, List[str]]                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ {                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   "auth.ts::login": [                                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     "auth.ts::validateToken",                               â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     "db.ts::query"                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   ],                                                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   "auth.ts::validateToken": [                               â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     "jwt.ts::verify"                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   ]                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ }                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ folder_activity: Dict[str, FolderStatus] (computed)         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ Aggregated view of which folders agents are working in      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ {                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   "src/auth/": {                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     users: ["Luka"],                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     symbols: ["validateToken", "login"],                    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     statuses: ["WRITING"]                                   â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   },                                                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   "src/db/": {                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     users: ["Jane"],                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     symbols: ["query"],                                     â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     statuses: ["READING"]                                   â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   }                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ }                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ status_log: List[StatusLogEntry] (NEW - Full History)      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ Permanent record of all status changes and activities       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ [                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   {                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     id: "log_001",                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     timestamp: 1234567890.0,                                â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: "luka",                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     action: "status_update",                                â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     symbol: "auth.ts::validateToken",                       â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     old_status: "READING",                                  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     new_status: "WRITING",                                  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     repo_head: "abc123def"                                  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   }                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ ]                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ chat_messages: List[ChatMessage] (NEW)                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ [                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   {                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     id: "chat_001",                                         â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     timestamp: 1234567890.0,                                â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_id: "luka",                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     user_name: "Luka",                                      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     message: "Should we refactor validateToken first?",     â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     context: {                                              â”‚    â”‚ â”‚
â”‚  â”‚  â”‚       symbol: "auth.ts::validateToken",                     â”‚    â”‚ â”‚
â”‚  â”‚  â”‚       thread_id: "thread_001"                               â”‚    â”‚ â”‚
â”‚  â”‚  â”‚     }                                                        â”‚    â”‚ â”‚
â”‚  â”‚  â”‚   }                                                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚ ]                                                            â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Background Tasks (Webapp - Async)                   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  cleanup_stale_locks():                                              â”‚ â”‚
â”‚  â”‚  â”œâ”€ Runs every 10 seconds (Vercel cron or background job)            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Checks last_heartbeat for each lock in lock_table                â”‚ â”‚
â”‚  â”‚  â”œâ”€ If > 60 seconds since heartbeat â†’ Expire lock                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ Broadcast "lock_expired" event via WebSocket                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ Log to status_log                                                â”‚ â”‚
â”‚  â”‚  â””â”€ Update lock_table (set to OPEN)                                  â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ MCP Protocol
                                       â”‚ (JSON-RPC over HTTPS/SSE)
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â–¼                                      â”‚
â”‚                    DEDALUS INFRASTRUCTURE LAYER                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Credential Encryption/Decryption Pipeline                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Client sends request:                                               â”‚ â”‚
â”‚  â”‚  {                                                                    â”‚ â”‚
â”‚  â”‚    tool: "check_interference",                                       â”‚ â”‚
â”‚  â”‚    params: { symbols: [...] },                                       â”‚ â”‚
â”‚  â”‚    credentials: {                                                    â”‚ â”‚
â”‚  â”‚      "COORD_API_KEY": "aG4kL9mPxY2zQ=="  â† Encrypted blob           â”‚ â”‚
â”‚  â”‚    }                                                                 â”‚ â”‚
â”‚  â”‚  }                                                                    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Dedalus Pipeline:                                                   â”‚ â”‚
â”‚  â”‚  1. Receive encrypted credential blob                                â”‚ â”‚
â”‚  â”‚  2. Route request to target MCP server                               â”‚ â”‚
â”‚  â”‚  3. Just-In-Time decryption in secure enclave                        â”‚ â”‚
â”‚  â”‚  4. Pass decrypted credential to MCP tool in context                 â”‚ â”‚
â”‚  â”‚  5. Tool executes with plaintext credential                          â”‚ â”‚
â”‚  â”‚  6. Credential discarded after tool completes                        â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Security Properties:                                                â”‚ â”‚
â”‚  â”‚  âœ“ Credentials never stored in plaintext                            â”‚ â”‚
â”‚  â”‚  âœ“ Decryption only at runtime (JIT)                                 â”‚ â”‚
â”‚  â”‚  âœ“ Isolated secure enclave environment                              â”‚ â”‚
â”‚  â”‚  âœ“ Multi-tenant by default                                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    DedalusRunner Orchestration                        â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  Handles:                                                            â”‚ â”‚
â”‚  â”‚  â€¢ Model routing (GPT-5, Claude Opus, etc.)                          â”‚ â”‚
â”‚  â”‚  â€¢ MCP server connection management                                  â”‚ â”‚
â”‚  â”‚  â€¢ Tool call formatting & execution                                  â”‚ â”‚
â”‚  â”‚  â€¢ Streaming response coordination                                   â”‚ â”‚
â”‚  â”‚  â€¢ Error handling & retries                                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ Agent API Calls
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â–¼                                      â”‚
â”‚                         AGENT EXECUTION LAYER                              â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Cursor Instance 1 (Luka)         â”‚  â”‚  Cursor Instance 2 (Jane)   â”‚ â”‚
â”‚  â”‚                                     â”‚  â”‚                             â”‚ â”‚
â”‚  â”‚  Environment:                       â”‚  â”‚  Environment:               â”‚ â”‚
â”‚  â”‚  .env:                              â”‚  â”‚  .env:                      â”‚ â”‚
â”‚  â”‚    COORD_API_KEY=                   â”‚  â”‚    COORD_API_KEY=           â”‚ â”‚
â”‚  â”‚      coord_sk_luka_abc123           â”‚  â”‚      coord_sk_jane_xyz789   â”‚ â”‚
â”‚  â”‚    DEDALUS_API_KEY=<shared>         â”‚  â”‚    DEDALUS_API_KEY=<shared> â”‚ â”‚
â”‚  â”‚                                     â”‚  â”‚                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Agent Setup Code              â”‚ â”‚  â”‚ â”‚  Agent Setup Code       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  from dedalus_mcp.auth import â”‚ â”‚  â”‚ â”‚  (Same setup,           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    Connection, SecretValues   â”‚ â”‚  â”‚ â”‚   different .env)       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  coord = Connection(          â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    name="coord-server",       â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    secrets=SecretKeys(        â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      key="COORD_API_KEY"      â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    )                           â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  )                             â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  coord_secrets = SecretValues(â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    coord,                     â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    key=os.getenv(             â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      "COORD_API_KEY"          â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    )                           â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  )                             â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â†“ Encrypts locally:          â”‚ â”‚  â”‚ â”‚  â†“ Encrypts locally:   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  coord_sk_luka_abc123         â”‚ â”‚  â”‚ â”‚  coord_sk_jane_xyz789  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â†’ aG4kL9m... (blob)           â”‚ â”‚  â”‚ â”‚  â†’ xB2mK8p... (blob)   â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                     â”‚  â”‚                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Claude Agent                  â”‚ â”‚  â”‚ â”‚  Claude Agent           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  System Prompt:                â”‚ â”‚  â”‚ â”‚  System Prompt:         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  "Before modifying code,       â”‚ â”‚  â”‚ â”‚  (Same prompt)          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   MUST call                    â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   check_interference"          â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                â”‚ â”‚  â”‚ â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  User: "Refactor auth"         â”‚ â”‚  â”‚ â”‚  User: "Add pwd reset"  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                           â”‚ â”‚  â”‚ â”‚    â†“                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Agent reasoning:              â”‚ â”‚  â”‚ â”‚  Agent reasoning:       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  1. Need to modify:            â”‚ â”‚  â”‚ â”‚  1. Need to modify:     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     - auth.ts::validateToken   â”‚ â”‚  â”‚ â”‚     - auth.ts::validate â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     - auth.ts::login           â”‚ â”‚  â”‚ â”‚     - auth.ts::reset    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  2. Must check first!          â”‚ â”‚  â”‚ â”‚  2. Must check first!   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                           â”‚ â”‚  â”‚ â”‚    â†“                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Calls MCP tool:               â”‚ â”‚  â”‚ â”‚  Calls MCP tool:        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  check_interference([...])     â”‚ â”‚  â”‚ â”‚  check_interference([]) â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                     â”‚  â”‚                             â”‚ â”‚
â”‚  â”‚  Current Task:                      â”‚  â”‚  Current Task:              â”‚ â”‚
â”‚  â”‚  Refactoring auth to JWT            â”‚  â”‚  Adding password reset      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagram 2: Authentication Flow (Dedalus Auth Deep Dive)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CREDENTIAL LIFECYCLE: START TO FINISH                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PHASE 1: Client-Side Setup (Luka's Machine)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Load from .env file          â”‚
â”‚                                      â”‚
â”‚ .env file on disk:                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ COORD_API_KEY=coord_sk_luka_abc12â”‚ â”‚
â”‚ â”‚ DEDALUS_API_KEY=dls_xxx...       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚ Python reads:                        â”‚
â”‚ api_key = os.getenv("COORD_API_KEY") â”‚
â”‚ # api_key = "coord_sk_luka_abc123"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Define Connection            â”‚
â”‚                                      â”‚
â”‚ coord_connection = Connection(       â”‚
â”‚     name="coordination-server",     â”‚
â”‚     secrets=SecretKeys(             â”‚
â”‚         key="COORD_API_KEY"         â”‚
â”‚     )                               â”‚
â”‚ )                                    â”‚
â”‚                                      â”‚
â”‚ This tells Dedalus:                 â”‚
â”‚ "When connecting to coord-server,   â”‚
â”‚  look for credential named           â”‚
â”‚  COORD_API_KEY"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Bind Credential              â”‚
â”‚                                      â”‚
â”‚ coord_secrets = SecretValues(        â”‚
â”‚     coord_connection,               â”‚
â”‚     key="coord_sk_luka_abc123"      â”‚
â”‚ )                                    â”‚
â”‚                                      â”‚
â”‚ âš¡ CLIENT-SIDE ENCRYPTION HAPPENS:   â”‚
â”‚                                      â”‚
â”‚ Plaintext:                          â”‚
â”‚   coord_sk_luka_abc123              â”‚
â”‚      â†“                               â”‚
â”‚ AES-256 Encryption (local only)     â”‚
â”‚      â†“                               â”‚
â”‚ Encrypted blob:                     â”‚
â”‚   aG4kL9mPxY2zQ8vT3nM1kL==          â”‚
â”‚                                      â”‚
â”‚ âœ“ Never leaves machine in plaintext â”‚
â”‚ âœ“ Encryption key never sent         â”‚
â”‚ âœ“ Only Dedalus can decrypt          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼

PHASE 2: Network Transit
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Agent Calls MCP Tool         â”‚
â”‚                                      â”‚
â”‚ runner.run(                          â”‚
â”‚     input="Check conflicts",        â”‚
â”‚     mcp_servers=[                   â”‚
â”‚         "user/coordination-server"  â”‚
â”‚     ],                              â”‚
â”‚     credentials=[coord_secrets]     â”‚
â”‚ )                                    â”‚
â”‚                                      â”‚
â”‚ Request sent over HTTPS:            â”‚
â”‚ {                                   â”‚
â”‚   "tool": "check_interference",     â”‚
â”‚   "params": {                       â”‚
â”‚     "symbols": ["auth.ts::login"]   â”‚
â”‚   },                                â”‚
â”‚   "credentials": {                  â”‚
â”‚     "COORD_API_KEY":                â”‚
â”‚       "aG4kL9mPxY2zQ8vT3nM1kL=="    â”‚
â”‚   }                    â†‘             â”‚
â”‚ }                      â”‚             â”‚
â”‚                        â”‚             â”‚
â”‚              Still encrypted!        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ HTTPS (TLS 1.3)
                   â”‚ Double encryption:
                   â”‚ 1. Dedalus encryption
                   â”‚ 2. HTTPS tunnel
                   â”‚
                   â–¼

PHASE 3: Dedalus Infrastructure
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Dedalus Receives Request     â”‚
â”‚                                      â”‚
â”‚ Router identifies:                   â”‚
â”‚ â€¢ Target: "user/coordination-server" â”‚
â”‚ â€¢ Tool: "check_interference"         â”‚
â”‚ â€¢ Has encrypted credentials          â”‚
â”‚                                      â”‚
â”‚ Routing decision:                    â”‚
â”‚ â†’ Forward to user's MCP server       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: Just-In-Time Decryption      â”‚
â”‚                                      â”‚
â”‚ ğŸ”’ Secure Enclave Environment        â”‚
â”‚                                      â”‚
â”‚ ONLY when tool is about to execute:  â”‚
â”‚                                      â”‚
â”‚ 1. Load encrypted blob:              â”‚
â”‚    aG4kL9mPxY2zQ8vT3nM1kL==          â”‚
â”‚                                      â”‚
â”‚ 2. Decrypt using Dedalus key:        â”‚
â”‚    (Happens in isolated memory)      â”‚
â”‚      â†“                               â”‚
â”‚    coord_sk_luka_abc123              â”‚
â”‚                                      â”‚
â”‚ 3. Place in context object:          â”‚
â”‚    context = {                       â”‚
â”‚        request_context: {            â”‚
â”‚            credentials: {            â”‚
â”‚                "COORD_API_KEY":      â”‚
â”‚                  "coord_sk_luka_abc" â”‚
â”‚            }                         â”‚
â”‚        }                             â”‚
â”‚    }                                 â”‚
â”‚                                      â”‚
â”‚ 4. Pass to MCP tool function         â”‚
â”‚                                      â”‚
â”‚ âš ï¸ CRITICAL SECURITY PROPERTIES:     â”‚
â”‚ â€¢ Plaintext only exists in memory   â”‚
â”‚ â€¢ Only during tool execution        â”‚
â”‚ â€¢ Never written to disk             â”‚
â”‚ â€¢ Never logged                      â”‚
â”‚ â€¢ Discarded immediately after       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼

PHASE 4: MCP Server Execution
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: Tool Receives Context        â”‚
â”‚                                      â”‚
â”‚ @tool(description="Check conflicts") â”‚
â”‚ async def check_interference(        â”‚
â”‚     request: CheckInterferenceReq,   â”‚
â”‚ ):                                   â”‚
â”‚     ctx = get_context()              â”‚
â”‚                                      â”‚
â”‚     # Extract plaintext credential   â”‚
â”‚     api_key = ctx.request_context    â”‚
â”‚         .credentials["COORD_API_KEY"]â”‚
â”‚                                      â”‚
â”‚     # api_key is now:                â”‚
â”‚     # "coord_sk_luka_abc123"         â”‚
â”‚     #         â†‘                      â”‚
â”‚     #    Plaintext!                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8: Authenticate User            â”‚
â”‚                                      â”‚
â”‚ def authenticate(api_key: str):      â”‚
â”‚     # Hash the API key               â”‚
â”‚     key_hash = sha256(api_key)       â”‚
â”‚     # key_hash = "7a3f2b..."         â”‚
â”‚                                      â”‚
â”‚     # Lookup in user database        â”‚
â”‚     user = USERS[key_hash]           â”‚
â”‚                                      â”‚
â”‚     # Returns:                       â”‚
â”‚     # {                              â”‚
â”‚     #   user_id: "luka",             â”‚
â”‚     #   email: "luka@example.com",   â”‚
â”‚     #   name: "Luka"                 â”‚
â”‚     # }                              â”‚
â”‚                                      â”‚
â”‚ âœ“ Now we know WHO made this request â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 9: Execute Business Logic       â”‚
â”‚                                      â”‚
â”‚ conflicts = []                       â”‚
â”‚                                      â”‚
â”‚ for symbol in request.symbols:       â”‚
â”‚     if symbol in lock_table:         â”‚
â”‚         lock = lock_table[symbol]    â”‚
â”‚                                      â”‚
â”‚         # Don't conflict with self   â”‚
â”‚         if lock.user_id == user_id:  â”‚
â”‚             continue                 â”‚
â”‚                                      â”‚
â”‚         conflicts.append({           â”‚
â”‚             "held_by_email":         â”‚
â”‚                 lock.user_email,     â”‚
â”‚             "status": lock.status    â”‚
â”‚         })                           â”‚
â”‚                                      â”‚
â”‚ return CheckInterferenceResponse(    â”‚
â”‚     your_email=user.email,           â”‚
â”‚     conflicts=conflicts              â”‚
â”‚ )                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼

PHASE 5: Cleanup
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 10: Credential Disposal         â”‚
â”‚                                      â”‚
â”‚ After tool completes:                â”‚
â”‚                                      â”‚
â”‚ 1. Return result to Dedalus          â”‚
â”‚ 2. Context object destroyed          â”‚
â”‚ 3. Plaintext credential removed      â”‚
â”‚    from memory                       â”‚
â”‚ 4. No trace of plaintext remains     â”‚
â”‚                                      â”‚
â”‚ Next tool call:                      â”‚
â”‚ â€¢ Repeat entire process              â”‚
â”‚ â€¢ Fresh decryption                   â”‚
â”‚ â€¢ No persistent plaintext            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SECURITY PROPERTIES SUMMARY:

âœ… Client-Side Encryption
   â†’ API key encrypted before leaving user's machine
   
âœ… Zero-Knowledge Architecture
   â†’ Dedalus never sees plaintext during storage/transit
   
âœ… Just-In-Time Decryption
   â†’ Plaintext only exists during tool execution
   
âœ… Secure Enclave Isolation
   â†’ Decryption happens in isolated environment
   
âœ… No Persistence
   â†’ Plaintext never written to disk/logs
   
âœ… Multi-Tenant by Default
   â†’ Each user has unique encrypted blob
   â†’ Server can't confuse users
   
âœ… Credential Rotation Ready
   â†’ User can change API key anytime
   â†’ Just update .env file
   â†’ No server-side changes needed

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Diagram 3: Real-Time Conflict Detection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONFLICT DETECTION: TWO AGENTS, ONE FUNCTION                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME: T=0
â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent A (Luka)             â”‚       â”‚  Agent B (Jane)             â”‚
â”‚                             â”‚       â”‚                             â”‚
â”‚  User: "Refactor auth"      â”‚       â”‚  User: "Add password reset" â”‚
â”‚                             â”‚       â”‚                             â”‚
â”‚  Agent thinks:              â”‚       â”‚  Agent thinks:              â”‚
â”‚  "I need to modify:         â”‚       â”‚  "I need to modify:         â”‚
â”‚   â€¢ auth.ts::validateToken  â”‚       â”‚   â€¢ auth.ts::validateToken  â”‚
â”‚   â€¢ auth.ts::login"         â”‚       â”‚   â€¢ auth.ts::resetPassword" â”‚
â”‚                             â”‚       â”‚                             â”‚
â”‚  âš ï¸ Both want validateToken â”‚       â”‚  âš ï¸ Both want validateToken â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                     â”‚
              â”‚ check_interference()                â”‚ check_interference()
              â”‚ (with Luka's credentials)           â”‚ (with Jane's credentials)
              â”‚                                     â”‚
              â–¼                                     â–¼

TIME: T=1 (Luka checks first)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP Server: Lock Table                         â”‚
â”‚                                                             â”‚
â”‚              Currently: EMPTY                               â”‚
â”‚              { }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Luka's check_interference arrives
                              â”‚ Symbols: ["auth.ts::validateToken",
                              â”‚           "auth.ts::login"]
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Execution:                                            â”‚
â”‚                                                             â”‚
â”‚  1. Authenticate: user = "luka"                             â”‚
â”‚  2. Check lock_table for each symbol                        â”‚
â”‚     â†’ "auth.ts::validateToken" NOT FOUND âœ“                 â”‚
â”‚     â†’ "auth.ts::login" NOT FOUND âœ“                         â”‚
â”‚  3. Check dependency graph for warnings                     â”‚
â”‚     â†’ validateToken depends on: ["jwt.ts::verify"]         â”‚
â”‚     â†’ jwt.ts::verify status: OPEN âœ“                        â”‚
â”‚     â†’ No dependencies being WRITTEN âœ“                      â”‚
â”‚                                                             â”‚
â”‚  Return: {                                                  â”‚
â”‚    conflicts: [],         â† CLEAR!                         â”‚
â”‚    warnings: []           â† No dependency conflicts        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent A (Luka) receives:   â”‚
â”‚                             â”‚
â”‚  "âœ… No conflicts detected  â”‚
â”‚   Safe to proceed!"         â”‚
â”‚                             â”‚
â”‚  Agent decides:             â”‚
â”‚  â†’ Start reading code       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ post_status()
              â”‚ symbol: "auth.ts::validateToken"
              â”‚ status: "READING"
              â”‚ message: "Analyzing auth flow"
              â”‚
              â”‚ post_activity()
              â”‚ message: "Starting auth refactor - analyzing current implementation"
              â”‚ layer: "backend/auth"
              â”‚
              â–¼

TIME: T=2 (Luka posts reading status)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP Server: Lock Table UPDATED                 â”‚
â”‚                                                             â”‚
â”‚  {                                                          â”‚
â”‚    "auth.ts::validateToken": {                             â”‚
â”‚      user_id: "luka",                                      â”‚
â”‚      user_email: "luka@example.com",                       â”‚
â”‚      status: "READING",  ğŸ”µ                                â”‚
â”‚      message: "Analyzing auth flow",                       â”‚
â”‚      timestamp: 1000,                                      â”‚
â”‚      last_heartbeat: 1000                                  â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â”‚  activity_feed:                                            â”‚
â”‚  [{                                                         â”‚
â”‚    user_name: "Luka",                                      â”‚
â”‚    message: "Starting auth refactor - analyzing current    â”‚
â”‚              implementation",                              â”‚
â”‚    layer: "backend/auth"                                   â”‚
â”‚  }]                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ WebSocket broadcast
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Graph Visualization UI Updates                   â”‚
â”‚                                                             â”‚
â”‚  Before: âšª validateToken (idle/OPEN)                      â”‚
â”‚  After:  ğŸ”µ validateToken (Luka - READING)                 â”‚
â”‚                                                             â”‚
â”‚  Folder View:                                              â”‚
â”‚  ğŸ“ src/auth/  ğŸ”µ Luka is reading here                     â”‚
â”‚                                                             â”‚
â”‚  Agent Activity Feed:                                      â”‚
â”‚  [12:00:02] Luka: Starting auth refactor - analyzing...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME: T=3 (Luka transitions to WRITING)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent A (Luka)             â”‚
â”‚                             â”‚
â”‚  Finished reading.          â”‚
â”‚  Now writing code.          â”‚
â”‚                             â”‚
â”‚  Calls: post_status()       â”‚
â”‚  status: "WRITING"          â”‚
â”‚                             â”‚
â”‚  Calls: post_activity()     â”‚
â”‚  message: "Implementing JWT"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP Server: Lock Table UPDATED                 â”‚
â”‚                                                             â”‚
â”‚  {                                                          â”‚
â”‚    "auth.ts::validateToken": {                             â”‚
â”‚      user_id: "luka",                                      â”‚
â”‚      user_email: "luka@example.com",                       â”‚
â”‚      status: "WRITING",  ğŸ”´ â† Changed!                     â”‚
â”‚      message: "Implementing JWT validation",               â”‚
â”‚      timestamp: 1000,                                      â”‚
â”‚      last_heartbeat: 1030                                  â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ WebSocket broadcast
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Graph Visualization UI Updates                   â”‚
â”‚                                                             â”‚
â”‚  Before: ğŸ”µ validateToken (Luka - READING)                 â”‚
â”‚  After:  ğŸ”´ validateToken (Luka - WRITING)                 â”‚
â”‚                                                             â”‚
â”‚  Folder View:                                              â”‚
â”‚  ğŸ“ src/auth/  ğŸ”´ Luka is WRITING here                     â”‚
â”‚                                                             â”‚
â”‚  Agent Activity Feed:                                      â”‚
â”‚  [12:00:30] Luka: Implementing JWT validation              â”‚
â”‚  [12:00:02] Luka: Starting auth refactor - analyzing...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME: T=4 (Jane's check arrives - CONFLICT!)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚  Agent B (Jane)             â”‚
                             â”‚                             â”‚
                             â”‚  Calls: check_interference()â”‚
                             â”‚  Symbols:                   â”‚
                             â”‚  ["auth.ts::validateToken", â”‚
                             â”‚   "auth.ts::resetPassword"] â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Server: Conflict Detection                             â”‚
â”‚                                                             â”‚
â”‚  1. Authenticate: user = "jane"                             â”‚
â”‚                                                             â”‚
â”‚  2. Check each symbol:                                      â”‚
â”‚                                                             â”‚
â”‚     Symbol: "auth.ts::validateToken"                       â”‚
â”‚     â”œâ”€ Check lock_table                                    â”‚
â”‚     â”œâ”€ FOUND! {                                            â”‚
â”‚     â”‚    user_id: "luka",                                  â”‚
â”‚     â”‚    status: "WRITING"  â† ğŸ”´ HARD CONFLICT!           â”‚
â”‚     â”‚  }                                                    â”‚
â”‚     â”œâ”€ Is it Jane? NO (it's Luka)                          â”‚
â”‚     â””â”€ Add to conflicts with severity: HIGH                â”‚
â”‚                                                             â”‚
â”‚     Symbol: "auth.ts::resetPassword"                       â”‚
â”‚     â”œâ”€ Check lock_table â†’ NOT FOUND âœ“                     â”‚
â”‚     â”œâ”€ Check dependencies: ["auth.ts::validateToken"]      â”‚
â”‚     â”œâ”€ validateToken is WRITING by Luka!                   â”‚
â”‚     â””â”€ Add to warnings: DEPENDENCY_CONFLICT                â”‚
â”‚                                                             â”‚
â”‚  Return: {                                                  â”‚
â”‚    your_email: "jane@example.com",                         â”‚
â”‚    conflicts: [                                            â”‚
â”‚      {                                                     â”‚
â”‚        symbol: "auth.ts::validateToken",                   â”‚
â”‚        held_by_email: "luka@example.com",                  â”‚
â”‚        held_by_name: "Luka",                               â”‚
â”‚        status: "WRITING",                                  â”‚
â”‚        message: "Implementing JWT validation",             â”‚
â”‚        severity: "HIGH"  â† âš ï¸ DANGER!                      â”‚
â”‚      }                                                     â”‚
â”‚    ],                                                       â”‚
â”‚    warnings: [                                             â”‚
â”‚      {                                                     â”‚
â”‚        type: "DEPENDENCY_CONFLICT",                        â”‚
â”‚        dependency: "auth.ts::validateToken",               â”‚
â”‚        held_by_name: "Luka",                               â”‚
â”‚        message: "Dependency is being WRITTEN, may have     â”‚
â”‚                 problems"                                  â”‚
â”‚      }                                                     â”‚
â”‚    ]                                                       â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent B (Jane) receives conflict info                      â”‚
â”‚                                                             â”‚
â”‚  System prompt rule:                                       â”‚
â”‚  "If severity = HIGH, MUST ask user for guidance"          â”‚
â”‚                                                             â”‚
â”‚  Agent generates message:                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Jane's Cursor UI Shows:                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âš ï¸ Conflict Detected                                  â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ DIRECT CONFLICT:                                      â”‚ â”‚
â”‚  â”‚ â€¢ auth.ts::validateToken is being WRITTEN by Luka    â”‚ â”‚
â”‚  â”‚   "Implementing JWT validation"                       â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ DEPENDENCY WARNING:                                   â”‚ â”‚
â”‚  â”‚ â€¢ auth.ts::resetPassword depends on validateToken    â”‚ â”‚
â”‚  â”‚ â€¢ validateToken is being modified, you may           â”‚ â”‚
â”‚  â”‚   experience problems if you proceed                 â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ Options:                                              â”‚ â”‚
â”‚  â”‚ 1. â¸ï¸ Wait for Luka to finish                         â”‚ â”‚
â”‚  â”‚ 2. âš¡ Proceed anyway (risky - may cause conflicts)    â”‚ â”‚
â”‚  â”‚ 3. ğŸ¯ Work on something else for now                  â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ What would you like me to do?                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Jane (the human) chooses option 3
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent B (Jane)             â”‚
â”‚                             â”‚
â”‚  Revised plan:              â”‚
â”‚  "I'll investigate the DB   â”‚
â”‚   timeout issue instead"    â”‚
â”‚                             â”‚
â”‚  Calls: check_interference()â”‚
â”‚  Symbols:                   â”‚
â”‚  ["db.ts::query"]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Server: Second Check                                   â”‚
â”‚                                                             â”‚
â”‚  Symbol: "db.ts::query"                                    â”‚
â”‚  â”œâ”€ Check lock_table â†’ NOT FOUND âœ“                        â”‚
â”‚  â”œâ”€ Check dependencies â†’ NOT FOUND âœ“                      â”‚
â”‚  â””â”€ CLEAR!                                                 â”‚
â”‚                                                             â”‚
â”‚  Return: {                                                  â”‚
â”‚    conflicts: [],  â† CLEAR!                                â”‚
â”‚    warnings: []    â† No dependency issues                  â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent B (Jane)             â”‚
â”‚                             â”‚
â”‚  "âœ… Safe to proceed!"      â”‚
â”‚                             â”‚
â”‚  Calls: post_status()       â”‚
â”‚  symbol: "db.ts::query"     â”‚
â”‚  status: "READING"          â”‚
â”‚                             â”‚
â”‚  Calls: post_activity()     â”‚
â”‚  message: "Investigating DB â”‚
â”‚           timeout issue"    â”‚
â”‚  layer: "backend/db"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼

TIME: T=5 (Both agents working - NO OVERLAP!)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP Server: Lock Table - Parallel Work         â”‚
â”‚                                                             â”‚
â”‚  lock_table: {                                             â”‚
â”‚    "auth.ts::validateToken": {                             â”‚
â”‚      user_id: "luka",                                      â”‚
â”‚      user_email: "luka@example.com",                       â”‚
â”‚      status: "WRITING",  ğŸ”´                                â”‚
â”‚      message: "Implementing JWT validation"                â”‚
â”‚    },                                                       â”‚
â”‚    "db.ts::query": {                                       â”‚
â”‚      user_id: "jane",                                      â”‚
â”‚      user_email: "jane@example.com",                       â”‚
â”‚      status: "READING",  ğŸ”µ                                â”‚
â”‚      message: "Investigating timeout issue"                â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â”‚  activity_feed: [                                          â”‚
â”‚    {user: "Jane", message: "Investigating DB timeout",     â”‚
â”‚     layer: "backend/db"},                                  â”‚
â”‚    {user: "Luka", message: "Implementing JWT validation",  â”‚
â”‚     layer: "backend/auth"}                                 â”‚
â”‚  ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ WebSocket broadcasts to all clients
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Graph Visualization - BOTH AGENTS VISIBLE        â”‚
â”‚                                                             â”‚
â”‚  ğŸ“ FOLDER VIEW:                                           â”‚
â”‚  â”œâ”€ ğŸ“ src/auth/  ğŸ”´ Luka is WRITING here                  â”‚
â”‚  â””â”€ ğŸ“ src/db/    ğŸ”µ Jane is READING here                  â”‚
â”‚                                                             â”‚
â”‚  ğŸ“„ SYMBOL VIEW:                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚    â”‚  auth.ts  â”‚              â”‚   db.ts   â”‚               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚                           â”‚                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â–¼                     â”‚
â”‚     â–¼         â–¼                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ query  â”‚                â”‚
â”‚  â”‚validateâ”‚ â”‚ login  â”‚           â”‚  ğŸ”µ    â”‚                â”‚
â”‚  â”‚Token   â”‚ â”‚        â”‚           â”‚  Jane  â”‚                â”‚
â”‚  â”‚  ğŸ”´    â”‚ â”‚ (OPEN) â”‚           â”‚READING â”‚                â”‚
â”‚  â”‚  Luka  â”‚ â”‚        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”‚WRITING â”‚ â”‚        â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                             â”‚
â”‚  DIFFERENT FOLDERS = âœ… SAFE COLLABORATION                 â”‚
â”‚                                                             â”‚
â”‚  Agent Activity Feed (Slack):                              â”‚
â”‚  [12:00:50] Jane: Investigating DB timeout issue           â”‚
â”‚             Layer: backend/db                              â”‚
â”‚  [12:00:30] Luka: Implementing JWT validation              â”‚
â”‚             Layer: backend/auth                            â”‚
â”‚  [12:00:02] Luka: Starting auth refactor - analyzing...    â”‚
â”‚             Layer: backend/auth                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

KEY INSIGHTS FROM THIS FLOW:

âœ… Conflict Detected BEFORE Code Changes
   â†’ Agents check first, write second

âœ… Dependency Warnings
   â†’ If dependency is being WRITTEN, agent is warned
   â†’ "validateToken is being modified, you may have problems"
   â†’ Prevents cascading conflicts

âœ… Human-Readable Context
   â†’ "Your teammate Luka" not "agent_a"
   â†’ Shows actual status and message

âœ… Three-State Model
   â†’ OPEN: Available (holds git timestamp)
   â†’ READING: Analyzing code
   â†’ WRITING: Actively modifying

âœ… Git Integration
   â†’ OPEN status tracks last commit info
   â†’ Agents handle git operations (commit, push, pull)
   â†’ MCP server only tracks coordination state

âœ… User Stays in Control
   â†’ Agent presents options with full context
   â†’ Human chooses strategy
   â†’ Agent adapts accordingly

âœ… Real-Time Visibility
   â†’ Graph shows symbol-level status
   â†’ Folder view shows which directories are active
   â†’ Agent activity feed (like Slack) for high-level updates
   â†’ WebSocket keeps everything synced

âœ… Parallel Work When Safe
   â†’ Different folders/symbols = no conflict
   â†’ Both agents progress independently
   â†’ Git merge happens smoothly

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## CORRECTED ARCHITECTURE: Stateless MCP + Vercel Storage + MCP WebSocket

### **The Actual Flow (Updated)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ARCHITECTURE LAYERS                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. AGENT
     â†“ (calls MCP tool via Dedalus)

2. DEDALUS MCP SERVER (STATELESS)
     â”œâ”€ Authenticates user
     â”œâ”€ GET state from Vercel REST API
     â”œâ”€ Applies coordination logic (detect conflicts, etc.)
     â”œâ”€ POST updates to Vercel REST API (if needed)
     â”œâ”€ Broadcasts event via WebSocket to UI clients
     â””â”€ Returns response to agent

3. VERCEL BACKEND (STATEFUL - REST API)
     â”œâ”€ Stores all state (locks, activity, repo_head, logs)
     â”œâ”€ REST endpoints: /api/state/*, /api/graph/*, /api/logs/*
     â”œâ”€ Connects to GitHub to generate dependency graph
     â””â”€ Returns state to MCP server

4. UI CLIENTS (Browser)
     â”œâ”€ Connects to MCP WebSocket for real-time updates
     â”œâ”€ Queries Vercel REST API for graph, logs, history
     â””â”€ Displays interactive graph with live status
```

### **Key Points:**

1. **MCP Server is STATELESS**
   - No in-memory state storage
   - Fetches state from Vercel on every request
   - Updates Vercel when changes occur

2. **MCP Server HAS WebSocket**
   - Broadcasts events to UI clients
   - Events sent AFTER updating Vercel
   - WebSocket connection managed by Dedalus (stateless)

3. **Vercel Backend is the Source of Truth**
   - REST API for state storage (GET/POST)
   - Persists to Vercel KV / Postgres
   - Connected to GitHub for graph generation

4. **UI Clients Listen to MCP WebSocket**
   - Real-time updates from MCP broadcasts
   - Can also query Vercel REST API directly for history

### **Example: post_status Flow**

```
Agent calls: post_status("auth.ts::validateToken", "WRITING")
     â†“
MCP Server (Dedalus):
  1. Authenticate user â†’ "luka"
  2. GET /api/state/locks from Vercel
  3. GET /api/state/repo_head from Vercel
  4. Check if symbol is locked â†’ No
  5. Validate agent_head == repo_head â†’ Yes
  6. POST /api/state/lock to Vercel:
       {
         "symbol": "auth.ts::validateToken",
         "user_id": "luka",
         "status": "WRITING",
         "agent_head": "abc123"
       }
  7. POST /api/logs/status to Vercel (history)
  8. Broadcast via WebSocket:
       {
         "event": "status_update",
         "symbol": "auth.ts::validateToken",
         "user": "luka",
         "status": "WRITING"
       }
  9. Return to agent: { "status": "SUCCESS" }
     â†“
UI Clients receive WebSocket event â†’ Update graph in real-time
```

### **Vercel Backend REST API Endpoints**

**State Storage:**
- `GET  /api/state/locks` â†’ Fetch all current locks
- `POST /api/state/lock` â†’ Update/create a lock
- `DELETE /api/state/lock` â†’ Remove lock (set status â†’ OPEN)
- `GET  /api/state/repo_head` â†’ Fetch current repo HEAD
- `POST /api/state/repo_head` â†’ Update repo HEAD
- `GET  /api/state/activity` â†’ Fetch activity feed
- `POST /api/state/activity` â†’ Add activity message

**Graph (GitHub Integration):**
- `POST /api/graph/generate` â†’ Analyze GitHub repo, build graph
- `GET  /api/graph` â†’ Fetch dependency graph
- `POST /api/graph/update` â†’ Update graph with new lock statuses

**Logs (History):**
- `POST /api/logs/status` â†’ Log status change
- `POST /api/logs/agent` â†’ Log agent activity
- `GET  /api/logs` â†’ Query historical logs

### **GitHub Integration (in Vercel)**

When `POST /api/graph/generate` is called:
1. Vercel connects to GitHub API (OAuth token)
2. Fetches repository contents
3. Parses files using AST (tree-sitter, babel, etc.)
4. Extracts symbols (functions, classes, methods)
5. Builds dependency edges (function calls, imports)
6. Stores graph in Vercel database
7. Returns graph structure to caller

### **UI Components (Served by Vercel)**

1. **Graph Visualization**:
   - Interactive D3.js/Cytoscape graph
   - Shows symbols with real-time status (ğŸ”´ WRITING, ğŸ”µ READING)
   - Folder-level and symbol-level views
   - Connects to MCP WebSocket for live updates

2. **Status Log**:
   - Displays activity feed and status history
   - Fetches from Vercel REST API
   - Time-travel debugging

3. **Agent Chat**:
   - Coordination communication interface
   - Stores messages in Vercel
   - Real-time via MCP WebSocket

---

## Critical Architecture Note: Stateless MCP + Vercel Storage

**IMPORTANT:** Dedalus MCP servers are **STATELESS** by design. This means:

- âŒ MCP server CANNOT store any state between calls
- âŒ No in-memory dictionaries, no persistent data structures
- âœ… MCP server fetches state from Vercel REST API when needed
- âœ… MCP server has WebSocket for broadcasting events
- âœ… ALL persistent state lives in **Vercel backend**

### **The Flow:**

```
Agent
  â†“ (MCP tool call with encrypted credentials)
Dedalus MCP Server (STATELESS)
  â†“ (authenticate user)
  â†“ (GET state from Vercel REST API)
Vercel Backend REST API
  â†“ (return current state: locks, repo_head, etc.)
Dedalus MCP Server
  â†“ (process request using fetched state)
  â†“ (if update needed: POST to Vercel REST API)
Vercel Backend REST API
  â†“ (update state: lock_table, activity_feed, etc.)
  â†“ (return success)
Dedalus MCP Server
  â†“ (broadcast event via WebSocket to UI clients)
  â†“ (return response to agent)
Agent
```

### **Vercel Backend Responsibilities:**

1. **State Storage (REST API)**:
   - POST /api/state/lock â†’ Update lock_table
   - GET /api/state/locks â†’ Fetch current locks
   - POST /api/state/activity â†’ Add activity message
   - GET /api/state/activity â†’ Fetch activity feed
   - POST /api/state/repo_head â†’ Update repo HEAD
   - GET /api/state/repo_head â†’ Fetch current HEAD

2. **Graph Generation (GitHub Integration)**:
   - Connect to GitHub via API or git clone
   - Analyze codebase (parse AST, extract symbols)
   - Build dependency graph
   - Store graph structure
   - API: POST /api/graph/generate, GET /api/graph

3. **Status Log**: Full history of all actions (time-travel debugging)

4. **Agent Logs**: Store all agent activity for debugging

### **MCP Server Responsibilities:**

1. **Authenticate**: Extract user identity from Dedalus credentials
2. **Fetch State**: GET from Vercel REST API when processing requests
3. **Update State**: POST to Vercel REST API when changes occur
4. **WebSocket Broadcasting**: Broadcast events to connected UI clients
5. **Business Logic**: Use fetched state to validate, detect conflicts, enforce rules
6. **Return Response**: Send result back to agent

**Key Insight:** MCP is stateless but NOT just a passthrough. It:
- Fetches state from Vercel
- Applies coordination logic
- Updates Vercel
- Broadcasts to UI
- Returns to agent

---

## Vercel Webapp Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          VERCEL WEBAPP STACK                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FRONTEND (Browser UI)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Next.js 14 (App Router)
â”œâ”€ /app/page.tsx          â†’ Main dashboard
â”œâ”€ /app/graph/page.tsx    â†’ Interactive graph visualization
â”œâ”€ /app/chat/page.tsx     â†’ Agent chat interface
â””â”€ /app/api/              â†’ API routes (backend)

COMPONENTS:
â”œâ”€ GraphVisualization     â†’ D3.js / Cytoscape.js graph rendering
â”œâ”€ StatusLog              â†’ Real-time activity feed
â”œâ”€ FolderView             â†’ Aggregated folder-level status
â”œâ”€ ChatPanel              â†’ Chat interface
â””â”€ StaleIndicator         â†’ Warns if local repo is behind

REAL-TIME:
â”œâ”€ WebSocket client       â†’ Receives broadcasts from server
â”œâ”€ Optimistic updates     â†’ Update UI immediately, sync later
â””â”€ Auto-reconnect         â†’ Handle connection drops

BACKEND (API Routes)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/app/api/check_status/route.ts
  POST /api/check_status
  Input: { user_id, symbols, agent_head }
  Output: { repo_head, locks, recent_activity, stale_status }

/app/api/post_status/route.ts
  POST /api/post_status
  Input: { user_id, symbol, status, message, agent_head?, new_repo_head? }
  Validates: Staleness, conflicts
  Returns: { status: "SUCCESS" } or { status: "REJECTED", reason: "..." }
  Side-effects: Updates lock_table, broadcasts event

/app/api/post_activity/route.ts
  POST /api/post_activity
  Input: { user_id, summary, scope, intent }
  Side-effects: Appends to activity_feed, broadcasts

/app/api/heartbeat/route.ts
  POST /api/heartbeat
  Input: { user_id, symbols }
  Side-effects: Updates last_heartbeat timestamps

/app/api/chat/route.ts
  POST /api/chat
  Input: { user_id, message, context }
  Side-effects: Appends to chat_messages, broadcasts

/app/api/graph/route.ts
  GET /api/graph
  Output: { nodes: [...], edges: [...] }

/app/api/generate_graph/route.ts
  POST /api/generate_graph
  Input: { repo_url, branch }
  Side-effects: Clones repo, analyzes, builds dependency_graph

WEBSOCKET SERVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Built with: Socket.io / Pusher / Ably (your choice)

Connection:
  wss://your-app.vercel.app/ws

Broadcast events:
  - status_update
  - activity_posted
  - lock_expired
  - conflict_warning
  - dependency_warning
  - chat_message

STATE STORAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Options for Vercel:

1. Vercel KV (Redis) - Fast, key-value
   âœ“ Good for lock_table, repo_head
   âœ“ Fast reads/writes
   âœ— Limited query capabilities

2. Vercel Postgres - Relational DB
   âœ“ Good for status_log, chat_messages
   âœ“ Complex queries, time-travel
   âœ— Slower than KV

3. Hybrid Approach (RECOMMENDED):
   - KV for hot data: lock_table, repo_head, active users
   - Postgres for history: status_log, chat_messages
   - In-memory for WebSocket connections

BACKGROUND JOBS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Vercel Cron Jobs (vercel.json):
{
  "crons": [
    {
      "path": "/api/cleanup_stale_locks",
      "schedule": "*/10 * * * * *"  // Every 10 seconds
    }
  ]
}

/app/api/cleanup_stale_locks/route.ts:
  - Query lock_table
  - Find locks where last_heartbeat > 60s ago
  - Set status to OPEN
  - Broadcast "lock_expired" event
  - Log to status_log

GRAPH CREATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Analyzes codebase and builds dependency graph:

/app/api/generate_graph/route.ts:
  1. Clone repo (or use GitHub API)
  2. Parse files with AST (tree-sitter / babel / swc)
  3. Extract symbols:
     - Functions
     - Classes
     - Methods
  4. Build dependency edges:
     - Function calls
     - Import statements
     - Inheritance relationships
  5. Store in dependency_graph
  6. Return graph structure

Example tools:
  - tree-sitter (multi-language parsing)
  - @babel/parser (JavaScript/TypeScript)
  - jedi (Python)
  - rust-analyzer (Rust)

DEPLOYMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

vercel.json:
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "env": {
    "KV_REST_API_URL": "@kv-url",
    "POSTGRES_URL": "@postgres-url"
  }
}

Environment variables:
  - KV_REST_API_URL: Vercel KV endpoint
  - KV_REST_API_TOKEN: Auth token
  - POSTGRES_URL: Database connection string
  - WEBSOCKET_SECRET: For WebSocket auth
```

---

## Diagram 4: Complete Git Integration & Staleness Protocol

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           GIT FRESHNESS MODEL: REPO-LEVEL HEAD TRACKING                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY PRINCIPLE: Freshness is tracked at REPO HEAD, not per-file
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Server State                                            â”‚
â”‚                                                              â”‚
â”‚  repo_head: "abc123def"  â† Latest known HEAD                â”‚
â”‚                                                              â”‚
â”‚  lock_table: {                                              â”‚
â”‚    "auth.ts::validateToken": {                             â”‚
â”‚      status: "WRITING",                                    â”‚
â”‚      user_id: "luka",                                      â”‚
â”‚      agent_head: "abc123def"  â† Agent's HEAD when locked  â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AGENT WORKFLOW: ENTERING WRITING STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Check Status       â”‚
â”‚                             â”‚
â”‚  Agent calls:               â”‚
â”‚  check_status()             â”‚
â”‚    â†“                        â”‚
â”‚  Returns: {                 â”‚
â”‚    repo_head: "abc123",     â”‚
â”‚    locks: {...},            â”‚
â”‚    recent_activity: [...]   â”‚
â”‚  }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Compare HEADs      â”‚
â”‚                             â”‚
â”‚  agent_head = git rev-parse â”‚
â”‚               HEAD          â”‚
â”‚  # "abc123"                 â”‚
â”‚                             â”‚
â”‚  if agent_head != repo_head:â”‚
â”‚    â†’ STALE! Must pull       â”‚
â”‚  else:                      â”‚
â”‚    â†’ Fresh, can proceed     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3a: If STALE          â”‚
â”‚                             â”‚
â”‚  git pull --rebase          â”‚
â”‚    â†“                        â”‚
â”‚  New agent_head: "def456"   â”‚
â”‚    â†“                        â”‚
â”‚  Re-run check_status()      â”‚
â”‚    â†“                        â”‚
â”‚  Verify no new conflicts    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3b: If Fresh          â”‚
â”‚                             â”‚
â”‚  Proceed to post_status()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Claim Lock         â”‚
â”‚                             â”‚
â”‚  post_status(               â”‚
â”‚    symbol="auth.ts::...",   â”‚
â”‚    status="WRITING",        â”‚
â”‚    agent_head="abc123"      â”‚
â”‚  )                          â”‚
â”‚    â†“                        â”‚
â”‚  MCP Server checks:         â”‚
â”‚  - Is symbol locked?        â”‚
â”‚  - Is agent_head == repo?   â”‚
â”‚    â†“                        â”‚
â”‚  If valid â†’ Lock granted    â”‚
â”‚  If stale â†’ REJECTED        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REJECTION RESPONSE (STALE REPO)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Response when agent is stale:                           â”‚
â”‚                                                              â”‚
â”‚  {                                                           â”‚
â”‚    "status": "REJECTED",                                    â”‚
â”‚    "reason": "STALE_REPO",                                  â”‚
â”‚    "message": "Your local repo is behind the latest         â”‚
â”‚                changes. Pull and retry.",                   â”‚
â”‚    "server_repo_head": "abc123def",                         â”‚
â”‚    "your_repo_head": "old789xyz",                           â”‚
â”‚    "required_action": "git pull --rebase"                   â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent MUST:                                                 â”‚
â”‚                                                              â”‚
â”‚  1. git pull --rebase                                       â”‚
â”‚  2. Re-run check_status() to get latest state               â”‚
â”‚  3. Verify no new conflicts appeared                        â”‚
â”‚  4. Retry post_status(WRITING) with new agent_head          â”‚
â”‚                                                              â”‚
â”‚  This is HARD FAIL + RETRY semantics.                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AGENT WORKFLOW: RELEASING CONTROL (GOING TO OPEN)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Complete Work      â”‚
â”‚                             â”‚
â”‚  Agent finishes editing     â”‚
â”‚  files locally              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Commit Changes     â”‚
â”‚                             â”‚
â”‚  git add .                  â”‚
â”‚  git commit -m "..."        â”‚
â”‚    â†“                        â”‚
â”‚  New HEAD: "xyz789abc"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Pull & Push        â”‚
â”‚                             â”‚
â”‚  git pull --rebase          â”‚
â”‚    â†“                        â”‚
â”‚  Resolve conflicts if any   â”‚
â”‚    â†“                        â”‚
â”‚  git push                   â”‚
â”‚    â†“                        â”‚
â”‚  Final HEAD: "final123"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Release Lock       â”‚
â”‚                             â”‚
â”‚  new_repo_head = git        â”‚
â”‚    rev-parse HEAD           â”‚
â”‚  # "final123"               â”‚
â”‚                             â”‚
â”‚  post_status(               â”‚
â”‚    symbol="auth.ts::...",   â”‚
â”‚    status="OPEN",           â”‚
â”‚    new_repo_head="final123" â”‚
â”‚  )                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Server Validation:                                     â”‚
â”‚                                                             â”‚
â”‚  1. Did repo_head advance?                                 â”‚
â”‚     old: "abc123def"                                       â”‚
â”‚     new: "final123"                                        â”‚
â”‚     âœ“ Advanced                                             â”‚
â”‚                                                             â”‚
â”‚  2. Update server state:                                   â”‚
â”‚     repo_head = "final123"                                 â”‚
â”‚     lock_table["auth.ts::validateToken"] = {              â”‚
â”‚       status: "OPEN",                                      â”‚
â”‚       last_commit_sha: "final123",                         â”‚
â”‚       last_commit_author: "luka",                          â”‚
â”‚       last_commit_time: <query git>                        â”‚
â”‚     }                                                       â”‚
â”‚                                                             â”‚
â”‚  3. Broadcast: "lock_released" event                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REJECTION: HEAD DID NOT ADVANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  If agent tries to release with unchanged HEAD:              â”‚
â”‚                                                              â”‚
â”‚  {                                                           â”‚
â”‚    "status": "REJECTED",                                    â”‚
â”‚    "reason": "HEAD_NOT_ADVANCED",                           â”‚
â”‚    "message": "You must commit and push before releasing.   â”‚
â”‚                Expected new HEAD, got same as before.",     â”‚
â”‚    "server_repo_head": "abc123",                            â”‚
â”‚    "your_repo_head": "abc123",  â† Same!                     â”‚
â”‚    "required_action": "git commit && git push"              â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MCP RESPONSIBILITIES (WHAT MCP DOES):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Track repo_head (latest known HEAD)
âœ… Validate agent_head matches repo_head before granting WRITING lock
âœ… Reject stale operations with clear error messages
âœ… Update repo_head when agent releases with new_repo_head
âœ… Query git for commit metadata (when status goes OPEN)
âœ… Enforce intent transitions (OPEN â†” READING â†” WRITING)
âœ… Broadcast events to connected clients

MCP DOES NOT DO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ Run any git commands itself
âŒ Commit files
âŒ Push to remote
âŒ Merge branches
âŒ Resolve conflicts
âŒ Edit filesystem directly
âŒ Enforce per-file locks (uses symbols/functions)
âŒ Track per-file dependency graph (optional future feature)
âŒ Provide chat/threading

AGENT RESPONSIBILITIES (WHAT AGENTS DO):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Run all git operations (pull, commit, push)
âœ… Check status before entering WRITING
âœ… Compare agent_head vs repo_head
âœ… Pull + rebase if stale
âœ… Edit files locally (Read/Write/Edit tools)
âœ… Commit changes with descriptive messages
âœ… Push to remote before releasing control
âœ… Post status updates to MCP
âœ… Handle merge conflicts if they occur
âœ… Retry failed operations after fixing staleness

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Protocol Design: Tool Usage Contracts

### **MCP Tool Descriptions Embed the Protocol**

Each MCP tool description includes the exact sequence agents must follow. This becomes the primary "how to use the server" instruction surface (vs a giant system prompt).

---

### **Tool 1: check_status**

**Description:**
```
Get current coordination state before taking action.

RETURNS:
  - repo_head: Latest known repository HEAD
  - locks: Who is READING/WRITING what symbols
  - recent_activity: Last N agent activity messages
  - stale_status: Whether your repo is behind

USAGE CONTRACT:
  1. Call this BEFORE entering WRITING state
  2. Compare your local HEAD: git rev-parse HEAD
  3. If your_head != repo_head:
     â†’ You are STALE
     â†’ git pull --rebase
     â†’ Re-run check_status
     â†’ Verify no new conflicts
  4. If fresh, proceed to post_status(WRITING)

RESPONSE SCHEMA:
{
  "repo_head": "abc123def",
  "locks": {
    "auth.ts::validateToken": {
      "status": "WRITING",
      "user_name": "Luka",
      "agent_head": "abc123def"
    }
  },
  "recent_activity": [
    {
      "timestamp": 1234567890,
      "user": "Luka",
      "scope": ["auth.ts"],
      "intent": "WRITING",
      "summary": "Refactoring validateToken to JWT"
    }
  ],
  "stale_status": {
    "is_stale": false,
    "your_head": "abc123def",
    "server_head": "abc123def"
  }
}
```

---

### **Tool 2: post_status**

**Description:**
```
Update your intent for a symbol: OPEN, READING, or WRITING.

PARAMETERS:
  - symbol: Code symbol (e.g., "auth.ts::validateToken")
  - status: "OPEN" | "READING" | "WRITING"
  - message: Short description of what you're doing
  - agent_head: (required for WRITING) Your current repo HEAD
  - new_repo_head: (required for OPEN) New HEAD after your commit

USAGE CONTRACT:

FOR ENTERING WRITING:
  1. Call check_status first
  2. Ensure your repo is fresh (pull if needed)
  3. Call post_status(symbol, "WRITING", agent_head=<your HEAD>)
  4. If REJECTED with STALE_REPO:
     â†’ git pull --rebase
     â†’ Re-run check_status
     â†’ Retry post_status

FOR RELEASING CONTROL (OPEN):
  1. Complete your edits
  2. git commit -m "descriptive message"
  3. git pull --rebase
  4. Resolve any conflicts
  5. git push
  6. Get new HEAD: git rev-parse HEAD
  7. Call post_status(symbol, "OPEN", new_repo_head=<new HEAD>)
  8. If REJECTED with HEAD_NOT_ADVANCED:
     â†’ You forgot to commit or push
     â†’ Fix and retry

REJECTION RESPONSES:
  - STALE_REPO: Your local repo is behind, pull and retry
  - SYMBOL_LOCKED: Someone else is WRITING this symbol
  - HEAD_NOT_ADVANCED: (for OPEN) Must commit + push first

SUCCESS RESPONSE:
{
  "status": "SUCCESS",
  "symbol": "auth.ts::validateToken",
  "new_status": "WRITING",
  "repo_head": "abc123def"
}

ERROR RESPONSE:
{
  "status": "REJECTED",
  "reason": "STALE_REPO",
  "message": "Your local repo is behind. Pull and retry.",
  "server_repo_head": "abc123def",
  "your_repo_head": "old789xyz",
  "required_action": "git pull --rebase"
}
```

---

### **Tool 3: post_activity**

**Description:**
```
Post a high-level activity update to the shared feed (like Slack).

USE THIS FOR:
  - Semantic boundaries (starting a new phase of work)
  - Context switches (moving to different layer/module)
  - Significant milestones (completed refactor, running tests)

DO NOT USE FOR:
  - Every file edit (too noisy)
  - Chat messages (not a chat system)
  - Debugging (use your own logs)

PARAMETERS:
  - summary: Brief description (1-2 sentences max)
  - scope: List of files/symbols you're working on
  - intent: "READING" | "WRITING" | "TESTING" | "DEBUGGING"

SCHEMA:
{
  "timestamp": <auto-generated>,
  "user": <from auth>,
  "scope": ["auth.ts", "jwt.ts"],
  "intent": "WRITING",
  "summary": "Refactoring validateToken to JWT-based auth"
}

WHEN TO POST:
  âœ“ Starting WRITING on a new area
  âœ“ Switching from one module to another
  âœ“ Finishing a major task
  âœ“ Encountering unexpected blockers

WHEN NOT TO POST:
  âœ— Every status change (use post_status for that)
  âœ— Conversational messages
  âœ— Progress percentages
```

---

### **Tool 4: heartbeat**

**Description:**
```
Keep your locks alive (60s timeout).

USAGE:
  - Call every 30-45 seconds while WRITING
  - Prevents lock expiration
  - No-op if you don't hold any locks

PARAMETERS:
  - symbols: List of symbols you're keeping alive

AUTO-EXPIRATION:
  If you don't heartbeat for >60s:
  - Lock is released automatically
  - Status set to OPEN
  - Event broadcast: "lock_expired"
```

---

## Intentional Agent Messages: Activity Feed Schema

**Activity Feed is NOT chat. It's short, high-signal updates.**

### **Message Schema:**
```json
{
  "timestamp": "2024-01-15T12:34:56Z",
  "user": "Luka",
  "scope": ["auth.ts", "jwt.ts"],
  "intent": "WRITING",
  "summary": "Refactoring validateToken to JWT-based auth"
}
```

### **When to Post:**
- **Semantic boundaries**: Starting WRITING, changing direction, finishing
- **Context switches**: Moving to different layer/module
- **Significant events**: Completed refactor, running tests, found blocker

### **When NOT to Post:**
- Every file edit (too noisy)
- Status changes (use `post_status` for that)
- Chat/conversation (not a messaging system)
- Internal debugging info

### **UI Display:**
Simple "Recent Agent Activity" panel showing last N messages:
```
Recent Agent Activity:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[12:34:56] Luka - WRITING
           Scope: auth.ts, jwt.ts
           Refactoring validateToken to JWT-based auth

[12:30:15] Jane - DEBUGGING
           Scope: db.ts
           Investigating connection timeout in query pool

[12:28:42] Luka - READING
           Scope: auth.ts
           Analyzing current authentication flow
```

---

## UI Responsibilities (Clarified)

### **UI Displays:**
- Current locks/statuses (symbol-level and folder-level)
- Current `repo_head`
- Activity feed messages
- "Client is stale" indicator (if `your_head != repo_head`)
- Real-time updates via WebSocket

### **UI Does NOT:**
- Run git commands
- Enforce any rules
- Commit or push code
- Resolve conflicts
- Control file access

**UI is purely observational + real-time display.**

---

## Dedalus Auth Role (Clarified)

**Used For:**
- âœ… Stable per-agent identity (who locked/posted)
- âœ… Reliable attribution across sessions
- âœ… Multi-tenant isolation
- âœ… Making MCP the single trusted coordination surface
- âœ… Preventing spoofing/impersonation

**How It Works:**
1. Each agent has unique API key: `coord_sk_luka_abc123`
2. Encrypted client-side, decrypted just-in-time by Dedalus
3. MCP server uses key to authenticate: `user = authenticate(api_key)`
4. All operations tagged with `user_id`, `user_email`, `user_name`

---

## Explicitly NOT Doing (Design Constraints)

To keep the hackathon scope manageable:

âŒ **Server-side git operations** - Agents handle all git
âŒ **Merge orchestration** - Agents resolve conflicts locally
âŒ **Chat threads/replies** - Activity feed is one-way broadcast
âŒ **Filesystem-level enforcement** - No file permissions/locks
âŒ **Per-file dependency graph as source of truth** - Optional future feature
âŒ **Automatic conflict resolution** - Human decides
âŒ **Code review workflows** - Out of scope
âŒ **Branch management** - Agents work on shared branch

---

## Architecture Design Decisions Summary

### 0. **Stateless MCP + Stateful Webapp (CRITICAL)**

**The Core Architecture:**

```
Agent â†’ Dedalus MCP (stateless) â†’ Vercel Webapp (stateful) â†’ Response
                                          â†“
                                    WebSocket broadcast
                                          â†“
                                    UI clients
```

**Dedalus MCP Server (STATELESS):**
- âŒ NO state storage between calls
- âœ… Authenticates user from encrypted credentials
- âœ… Forwards to Vercel webapp API
- âœ… Returns webapp response to agent

**Vercel Webapp (STATEFUL):**
- âœ… Stores ALL state: lock_table, activity_feed, repo_head, status_log, chat
- âœ… Exposes API endpoints: /api/check_status, /api/post_status, etc.
- âœ… WebSocket server for real-time broadcasts
- âœ… Background jobs (cleanup stale locks every 10s)
- âœ… Graph creator (analyzes codebase, builds dependency graph)
- âœ… Graph UI (interactive visualization)
- âœ… Status log (full history for time-travel debugging)
- âœ… Chat (agent-to-agent communication)

**Why This Matters:**
- Dedalus requires MCP servers to be stateless
- All persistence happens in the webapp (Vercel KV/Postgres)
- MCP is just a thin authentication + forwarding layer
- Webapp handles all business logic, state management, and UI

---

### 1. **Status Model: OPEN â†’ READING â†’ WRITING**

**Three States:**
- `OPEN`: Symbol is available, holds last git commit metadata
- `READING`: Agent is analyzing/reading the code
- `WRITING`: Agent is actively modifying the code

**Flow:**
```
OPEN â†’ READING â†’ WRITING â†’ OPEN (via git commit)
```

**OPEN Status Special Behavior:**
When an agent posts `status: "OPEN"`, the MCP server:
1. Queries git for the last commit affecting that file
2. Stores commit metadata: SHA, timestamp, author, message
3. Other agents can see when the code was last changed

### 2. **Git Integration Strategy**

**Division of Responsibilities:**
- **MCP Server**: Tracks coordination state (who's working on what)
- **Agents**: Handle all git operations (commit, push, pull)

**Agent Workflow:**
1. Check interference via MCP
2. Post status "READING" via MCP
3. Read files locally
4. Post status "WRITING" via MCP
5. Edit files locally
6. Commit + push via git (agent does this)
7. Post status "OPEN" via MCP (server queries git)

**Why This Works:**
- Agents use normal file operations (Read/Write/Edit tools)
- Git operations are standard (no special server-side logic)
- MCP server stays lightweight (just coordination)
- Each agent works in their own git worktree or clone

### 3. **Dependency Warnings**

**Enhanced Conflict Detection:**
When `check_interference()` is called, the server checks:
1. **Direct conflicts**: Is the symbol being READING or WRITING?
2. **Dependency conflicts**: Are any dependencies being WRITTEN?

**Example:**
```
Jane wants to edit: auth.ts::resetPassword
Dependencies: [auth.ts::validateToken]

If validateToken is being WRITTEN by Luka:
â†’ WARNING: "Dependency validateToken is being modified,
           you may experience problems"
```

**Agent Response:**
- Shows both direct conflicts AND dependency warnings
- Lets human decide whether to proceed or wait
- Prevents cascading conflicts

### 4. **Agent Activity Feed ("Agent Slack")**

**Purpose:** High-level narrative updates about what agents are doing

**Two Levels of Updates:**
1. **Status updates** (fine-grained): "READING auth.ts::validateToken"
2. **Activity feed** (coarse-grained): "Moving to database layer to investigate timeout"

**New MCP Tools:**
```
post_activity(message, layer, task_type)
  â†’ "Starting authentication refactor"
  â†’ Layer: "backend/auth"
  â†’ Type: "refactor"

get_activity_feed(since_timestamp)
  â†’ Returns recent activity from all agents
```

**UI Display:**
```
Agent Activity Feed:
[12:03:45] Luka: Auth refactor complete, running tests
           Layer: backend/auth
[12:01:30] Jane: Investigating DB connection timeout
           Layer: backend/db
```

### 5. **Folder-Level Visualization**

**Aggregated View:**
The UI shows which folders agents are working in:

```
ğŸ“ src/auth/  ğŸ”´ Luka is WRITING here
ğŸ“ src/db/    ğŸ”µ Jane is READING here
ğŸ“ src/api/   âšª No activity
```

**Computed from lock_table:**
```python
# Server computes folder activity on-the-fly
folder_activity = {
  "src/auth/": {
    users: ["Luka"],
    symbols: ["validateToken", "login"],
    statuses: ["WRITING"]
  }
}
```

**Benefits:**
- Quick overview of where work is happening
- Easier to identify safe areas to work
- Visual separation of concerns

### 6. **Complete MCP Tools List**

**Coordination Tools:**
- `check_interference(symbols)` â†’ Returns conflicts + dependency warnings
- `post_status(symbol, status, message)` â†’ OPEN/READING/WRITING
- `heartbeat(symbols)` â†’ Keep locks alive (60s timeout)

**Activity Feed Tools:**
- `post_activity(message, layer, task_type)` â†’ Post to activity feed
- `get_activity_feed(since_timestamp)` â†’ Get recent updates

**Query Tools:**
- `get_folder_activity()` â†’ Get aggregated folder status

**Removed:**
- ~~`release(symbols)`~~ â†’ Use `post_status(symbol, "OPEN")` instead

### 7. **WebSocket Events**

**Broadcast Events:**
- `status_update` â†’ Symbol status changed (OPEN/READING/WRITING)
- `activity_posted` â†’ New activity feed message
- `lock_expired` â†’ Lock timed out (no heartbeat for 60s)
- `conflict_warning` â†’ Direct conflict detected
- `dependency_warning` â†’ Dependency being WRITTEN

### 8. **Data Structures**

**lock_table:**
```python
{
  "auth.ts::validateToken": {
    status: "WRITING",
    user_id: "luka",
    user_email: "luka@example.com",
    user_name: "Luka",
    message: "Implementing JWT",
    timestamp: 1234567890.0,
    last_heartbeat: 1234567920.0
  },
  "auth.ts::login": {
    status: "OPEN",  # Available
    user_id: null,
    last_commit_sha: "abc123",
    last_commit_time: 1234567800.0,
    last_commit_author: "jane",
    last_commit_message: "feat: improve login"
  }
}
```

**activity_feed:**
```python
[
  {
    id: "act_001",
    user_name: "Luka",
    message: "Moving to database layer",
    timestamp: 1234567890.0,
    context: {
      layer: "backend/db",
      task_type: "refactor"
    }
  }
]
```

**folder_activity (computed):**
```python
{
  "src/auth/": {
    users: ["Luka"],
    symbols: ["validateToken"],
    statuses: ["WRITING"]
  }
}
```

This visual architecture gives you the complete picture without any code! ğŸ¨
